<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>Bir Bulut Olsam ‚Äî Etkinlik Check-in</title>
  <meta name="theme-color" content="#5B8DEF" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root{
      --bg:#F4F7FF; 
      --card:#FFFFFF; 
      --primary:#5B8DEF; 
      --primary-700:#355CD6; 
      --primary-light:#dbeafe;
      --accent:#8EE1F7;
      --ok:#0f766e; 
      --err:#b91c1c; 
      --text:#111827; 
      --muted:#64748b; 
      --shadow:0 10px 30px rgba(43,78,255,.12);
      --radius:18px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    [data-theme="dark"] {
      --bg:#0f172a;
      --card:#1e293b;
      --text:#f1f5f9;
      --muted:#94a3b8;
      --primary-light:#1e3a8a;
    }
    
    * { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
    
    html,body {
      margin:0;
      background:radial-gradient(1200px 600px at 80% -10%, var(--primary-light) 0%, transparent 60%), var(--bg);
      color:var(--text);
      font-family:'Inter',ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      transition: var(--transition);
      overflow-x:hidden;
    }
    
    body { min-height:100vh; position:relative; }
    
    /* NAVBAR - Mobile Optimized */
    .navbar {
      background:var(--card);
      border-bottom:1px solid rgba(0,0,0,.08);
      padding:14px 0;
      position:sticky;
      top:0;
      z-index:100;
      backdrop-filter:blur(10px);
      box-shadow:var(--shadow);
    }
    
    .navbar-content {
      max-width:1200px;
      margin:0 auto;
      padding:0 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    
    .navbar-brand {
      display:flex;
      align-items:center;
      gap:10px;
    }
    
    .navbar-logo {
      width:36px;
      height:36px;
      border-radius:10px;
      background:linear-gradient(135deg,var(--primary),var(--accent));
      box-shadow:0 4px 12px rgba(91,141,239,.35);
      position:relative;
      flex-shrink:0;
    }
    
    .navbar-logo:before,.navbar-logo:after {
      content:"";
      position:absolute;
      background:#fff;
      border-radius:999px;
      opacity:.9;
    }
    
    .navbar-logo:before { width:14px; height:14px; left:6px; top:11px; }
    .navbar-logo:after { width:20px; height:20px; left:14px; top:6px; }
    
    .navbar-text h1 {
      font-size:clamp(0.95rem, 4vw, 1.2rem);
      font-weight:700;
      margin:0;
      line-height:1.2;
    }
    
    .navbar-text .sub {
      font-size:clamp(0.75rem, 3vw, 0.85rem);
      color:var(--muted);
      display:none;
    }
    
    @media (min-width:480px) {
      .navbar-text .sub { display:block; }
    }
    
    .theme-toggle {
      background:var(--card);
      border:1px solid rgba(0,0,0,.1);
      width:40px;
      height:40px;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:var(--transition);
      font-size:1.2rem;
      flex-shrink:0;
      touch-action:manipulation;
    }
    
    .theme-toggle:active { transform:scale(0.95); }
    
    /* CONSTELLATION MAP */
    .constellation-container {
      background:linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
      border-radius:var(--radius);
      padding:24px 16px;
      margin:16px;
      position:relative;
      overflow:hidden;
      min-height:200px;
      box-shadow:var(--shadow);
    }
    
    .constellation-title {
      text-align:center;
      color:#fff;
      font-size:clamp(1rem, 4vw, 1.3rem);
      font-weight:700;
      margin-bottom:8px;
      position:relative;
      z-index:2;
    }
    
    .constellation-subtitle {
      text-align:center;
      color:rgba(255,255,255,0.7);
      font-size:clamp(0.8rem, 3vw, 0.9rem);
      margin-bottom:16px;
      position:relative;
      z-index:2;
    }
    
    .constellation-canvas {
      width:100%;
      height:220px;
      position:relative;
      touch-action:pan-y;
    }
    
    @media (min-width:768px) {
      .constellation-canvas { height:280px; }
    }
    
    .star {
      position:absolute;
      width:8px;
      height:8px;
      background:#fff;
      border-radius:50%;
      box-shadow:0 0 10px rgba(255,255,255,0.8), 0 0 20px rgba(255,255,255,0.4);
      animation:twinkle 3s ease-in-out infinite;
      cursor:pointer;
      transition:transform 0.2s;
      touch-action:manipulation;
    }
    
    .star:active { transform:scale(1.3); }
    
    .star-name-label {
      position:absolute;
      bottom:12px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(255,255,255,0.95);
      color:#0f172a;
      padding:3px 8px;
      border-radius:10px;
      font-size:0.7rem;
      font-weight:600;
      white-space:nowrap;
      pointer-events:none;
      z-index:5;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
      border:1px solid rgba(255,255,255,0.3);
    }
    
    @keyframes twinkle {
      0%, 100% { opacity:1; transform:scale(1); }
      50% { opacity:0.6; transform:scale(0.9); }
    }
    
    .star-line {
      position:absolute;
      background:rgba(255,255,255,0.2);
      height:1px;
      transform-origin:0 0;
      pointer-events:none;
    }
    
    .star-tooltip {
      position:absolute;
      background:rgba(0,0,0,0.9);
      color:#fff;
      padding:6px 10px;
      border-radius:6px;
      font-size:0.8rem;
      white-space:nowrap;
      pointer-events:none;
      z-index:10;
      opacity:0;
      transition:opacity 0.2s;
    }
    
    .star-tooltip.show { opacity:1; }
    
    /* Participants List */
    .participants-list {
      background:rgba(255,255,255,0.05);
      border-radius:12px;
      padding:12px;
      margin-bottom:16px;
      max-height:160px;
      overflow-y:auto;
      position:relative;
      z-index:2;
    }
    
    .participants-list::-webkit-scrollbar {
      width:4px;
    }
    
    .participants-list::-webkit-scrollbar-track {
      background:rgba(255,255,255,0.1);
      border-radius:2px;
    }
    
    .participants-list::-webkit-scrollbar-thumb {
      background:rgba(255,255,255,0.3);
      border-radius:2px;
    }
    
    .participants-grid {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    
    .participant-item {
      font-size:0.8rem;
      color:#fff;
      padding:4px 10px;
      background:rgba(255,255,255,0.1);
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.2);
      white-space:nowrap;
    }
    
    .participants-empty {
      text-align:center;
      color:rgba(255,255,255,0.5);
      font-size:0.85rem;
      padding:16px;
      font-style:italic;
    }
    
    /* MOOD SELECTOR */
    .mood-container {
      background:var(--card);
      border-radius:var(--radius);
      padding:20px 16px;
      margin:16px;
      box-shadow:var(--shadow);
      border:1px solid rgba(0,0,0,.05);
    }
    
    .mood-title {
      text-align:center;
      font-size:clamp(1rem, 4vw, 1.2rem);
      font-weight:700;
      margin-bottom:16px;
    }
    
    .mood-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(70px, 1fr));
      gap:12px;
      max-width:400px;
      margin:0 auto;
    }
    
    @media (min-width:480px) {
      .mood-grid { gap:16px; }
    }
    
    .mood-option {
      background:linear-gradient(135deg, rgba(91,141,239,0.05), rgba(142,225,247,0.05));
      border:2px solid transparent;
      border-radius:16px;
      padding:16px 8px;
      text-align:center;
      cursor:pointer;
      transition:var(--transition);
      touch-action:manipulation;
      user-select:none;
    }
    
    .mood-option:active { transform:scale(0.95); }
    
    .mood-option:hover {
      background:linear-gradient(135deg, rgba(91,141,239,0.1), rgba(142,225,247,0.1));
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(91,141,239,0.2);
    }
    
    .mood-option.selected {
      background:linear-gradient(135deg, var(--primary), var(--accent));
      border-color:var(--primary);
      transform:scale(1.05);
      box-shadow:0 6px 20px rgba(91,141,239,0.4);
    }
    
    .mood-emoji {
      font-size:clamp(2rem, 8vw, 2.5rem);
      display:block;
      margin-bottom:6px;
      line-height:1;
    }
    
    .mood-label {
      font-size:clamp(0.75rem, 3vw, 0.85rem);
      font-weight:600;
      color:var(--text);
    }
    
    .mood-option.selected .mood-label { color:#fff; }
    
    .mood-stats {
      margin-top:16px;
      padding:12px;
      background:rgba(91,141,239,0.05);
      border-radius:12px;
      text-align:center;
      font-size:clamp(0.8rem, 3vw, 0.9rem);
      color:var(--muted);
    }
    
    /* Star name labels - always visible */
    .star-name {
      position:absolute;
      bottom:-22px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.8);
      color:#fff;
      padding:4px 8px;
      border-radius:6px;
      font-size:0.7rem;
      white-space:nowrap;
      pointer-events:none;
      z-index:5;
      box-shadow:0 2px 8px rgba(0,0,0,0.3);
    }
    
    /* FORM STYLES - Mobile First */
    .form-container {
      background:var(--card);
      border-radius:var(--radius);
      padding:20px 16px;
      margin:16px;
      box-shadow:var(--shadow);
      border:1px solid rgba(0,0,0,.05);
    }
    
    label {
      display:block;
      font-weight:600;
      margin:12px 0 6px;
      font-size:clamp(0.85rem, 3.5vw, 0.95rem);
    }
    
    select, input[type="text"], input[type="tel"], input[type="email"] {
      width:100%;
      padding:14px 12px;
      border:2px solid #e5e7eb;
      border-radius:12px;
      font-size:clamp(0.95rem, 4vw, 1rem);
      outline:none;
      background:var(--card);
      color:var(--text);
      transition:var(--transition);
      -webkit-appearance:none;
      appearance:none;
      touch-action:manipulation;
    }
    
    select:focus, input:focus {
      border-color:var(--primary);
      box-shadow:0 0 0 4px rgba(91,141,239,.12);
    }
    
    .grid {
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    
    @media (min-width:640px) {
      .grid { grid-template-columns:1fr 1fr; }
    }
    
    /* KVKK */
    .kvkk-wrap {
      margin-top:16px;
      border:1px solid #e2e8f0;
      border-radius:14px;
      overflow:hidden;
      background:#fafcff;
    }
    
    [data-theme="dark"] .kvkk-wrap {
      background:rgba(255,255,255,.03);
      border-color:rgba(255,255,255,.1);
    }
    
    .kvkk-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:12px;
      background:linear-gradient(180deg,#f0f7ff,#ecf3ff);
      border-bottom:1px solid #e2e8f0;
    }
    
    [data-theme="dark"] .kvkk-head { background:rgba(91,141,239,.1); }
    
    .kvkk-head h3 {
      margin:0;
      font-size:clamp(0.85rem, 3.5vw, 1rem);
      line-height:1.3;
    }
    
    .kvkk-badge {
      font-size:clamp(0.7rem, 3vw, 0.8rem);
      color:#334155;
      background:#e2e8f0;
      padding:4px 8px;
      border-radius:999px;
      white-space:nowrap;
      flex-shrink:0;
    }
    
    .kvkk-content {
      padding:12px;
      line-height:1.6;
      white-space:pre-wrap;
      font-size:clamp(0.8rem, 3.5vw, 0.95rem);
      color:var(--muted);
      max-height:150px;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
    }
    
    .kvkk-controls {
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:12px;
      padding:0 12px 12px;
    }
    
    .checkbox {
      width:22px;
      height:22px;
      cursor:pointer;
      flex-shrink:0;
      touch-action:manipulation;
    }
    
    .kvkk-controls label {
      margin:0;
      font-size:clamp(0.8rem, 3.5vw, 0.9rem);
      line-height:1.4;
    }
    
    /* BUTTON - Touch Optimized */
    .btn {
      width:100%;
      padding:16px;
      border:0;
      border-radius:12px;
      font-weight:700;
      font-size:clamp(0.95rem, 4vw, 1.05rem);
      color:#fff;
      background:linear-gradient(135deg,var(--primary),var(--primary-700));
      cursor:pointer;
      box-shadow:0 10px 24px rgba(53,92,214,.25);
      transition:var(--transition);
      position:relative;
      overflow:hidden;
      touch-action:manipulation;
      -webkit-tap-highlight-color:transparent;
      min-height:52px;
    }
    
    .btn:active:not(:disabled) { transform:scale(0.98); }
    
    .btn:disabled {
      opacity:.65;
      cursor:not-allowed;
      box-shadow:none;
    }
    
    .status {
      margin-top:12px;
      font-size:clamp(0.85rem, 3.5vw, 0.95rem);
      padding:12px;
      border-radius:10px;
      animation:slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from { opacity:0; transform:translateY(-10px); }
      to { opacity:1; transform:translateY(0); }
    }
    
    .ok {
      color:var(--ok);
      background:rgba(15,118,110,.1);
      border:1px solid rgba(15,118,110,.2);
    }
    
    .err {
      color:var(--err);
      background:rgba(185,28,28,.1);
      border:1px solid rgba(185,28,28,.2);
    }
    
    /* FOOTER */
    .footer {
      text-align:center;
      color:var(--muted);
      font-size:clamp(0.8rem, 3.5vw, 0.9rem);
      margin-top:24px;
      padding:20px 16px;
    }
    
    .footer a {
      color:var(--primary);
      text-decoration:none;
    }
    
    /* SUCCESS MODAL - Mobile Optimized */
    .overlay {
      position:fixed;
      inset:0;
      background:rgba(9,12,22,.85);
      backdrop-filter:saturate(120%) blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:16px;
      animation:overlayFadeIn 0.3s ease-out;
    }
    
    @keyframes overlayFadeIn {
      from { opacity:0; }
      to { opacity:1; }
    }
    
    .overlay.open { display:flex; }
    
    .modal {
      max-width:min(500px, 100%);
      width:100%;
      background:var(--card);
      border-radius:22px;
      padding:28px 20px;
      box-shadow:0 24px 80px rgba(0,0,0,.3);
      text-align:center;
      position:relative;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.1);
      animation:modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    @keyframes modalSlideIn {
      from { opacity:0; transform:scale(0.8) translateY(40px); }
      to { opacity:1; transform:scale(1) translateY(0); }
    }
    
    .modal h2 {
      font-size:clamp(1.3rem, 5vw, 1.8rem);
      margin:0 0 8px;
      line-height:1.3;
    }
    
    .modal .lead {
      font-weight:800;
      letter-spacing:.5px;
      font-size:clamp(1.2rem, 5vw, 1.6rem);
      background:linear-gradient(135deg,#4da3ff,#7bdaff,#7bf5c5);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      margin-bottom:12px;
    }
    
    .modal p {
      margin:0 0 8px;
      color:var(--text);
      line-height:1.6;
      font-size:clamp(0.9rem, 4vw, 1rem);
    }
    
    .modal .sub {
      font-size:clamp(0.8rem, 3.5vw, 0.9rem);
      color:var(--muted);
    }
    
    .modal .btn-close {
      margin-top:20px;
      display:inline-block;
      padding:14px 28px;
      border-radius:12px;
      border:0;
      background:linear-gradient(135deg,#111,#333);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      transition:var(--transition);
      touch-action:manipulation;
      font-size:clamp(0.9rem, 4vw, 1rem);
      min-height:48px;
    }
    
    .modal .btn-close:active { transform:scale(0.95); }
    
    .confetti {
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    
    /* SPINNER */
    .spinner {
      display:inline-block;
      width:18px;
      height:18px;
      border:3px solid rgba(255,255,255,.3);
      border-top-color:white;
      border-radius:50%;
      animation:spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform:rotate(360deg); }
    }
    
    /* MOBILE SPECIFIC */
    @media (max-width:767px) {
      .wrap { padding:0; }
      .navbar-content { padding:0 12px; }
    }
    
    /* Prevent zoom on input focus (iOS) */
    @media (max-width:767px) {
      input[type="text"], input[type="tel"], input[type="email"], select {
        font-size:16px !important;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="navbar-content">
      <div class="navbar-brand">
        <div class="navbar-logo" aria-hidden="true"></div>
        <div class="navbar-text">
          <h1>Bir Bulut Olsam</h1>
          <div class="sub">Etkinlik Check-in</div>
        </div>
      </div>
      <button class="theme-toggle" id="themeToggle" aria-label="Tema Deƒüi≈ütir">
        <span id="themeIcon">üåô</span>
      </button>
    </div>
  </nav>

  <div class="wrap">
    <!-- Constellation Map -->
    <div class="constellation-container">
      <div class="constellation-title">‚≠ê Takƒ±myƒ±ldƒ±zƒ±mƒ±z</div>
      <div class="constellation-subtitle" id="constellationSubtitle">Son katƒ±lƒ±mcƒ±larƒ±mƒ±z burada!</div>
      
      <!-- Participants List -->
      <div class="participants-list" id="participantsList">
        <div class="participants-empty">Katƒ±lƒ±mcƒ±lar y√ºkleniyor...</div>
      </div>
      
      <!-- Constellation Canvas -->
      <div class="constellation-canvas" id="constellationCanvas"></div>
      <div class="star-tooltip" id="starTooltip"></div>
    </div>

    <!-- Mood Selector -->
    <div class="mood-container">
      <div class="mood-title">Bug√ºn nasƒ±l hissediyorsun? üòä</div>
      <div class="mood-grid">
        <div class="mood-option" data-mood="happy">
          <span class="mood-emoji">üòä</span>
          <span class="mood-label">Mutlu</span>
        </div>
        <div class="mood-option" data-mood="excited">
          <span class="mood-emoji">ü§ó</span>
          <span class="mood-label">Heyecanlƒ±</span>
        </div>
        <div class="mood-option" data-mood="cool">
          <span class="mood-emoji">üòé</span>
          <span class="mood-label">Havalƒ±</span>
        </div>
        <div class="mood-option" data-mood="tired">
          <span class="mood-emoji">üò¥</span>
          <span class="mood-label">Yorgun</span>
        </div>
      </div>
      <div class="mood-stats" id="moodStats">Bir ruh hali se√ß ve check-in yap!</div>
    </div>

    <!-- Check-in Form -->
    <div class="form-container">
      <label for="event">Etkinlik Se√ß *</label>
      <select id="event">
        <option value="">Y√ºkleniyor‚Ä¶</option>
      </select>

      <div class="grid">
        <div>
          <label for="name">Ad Soyad *</label>
          <input id="name" type="text" placeholder="Ad Soyad" autocomplete="name" />
        </div>
        <div>
          <label for="phone">Telefon *</label>
          <input id="phone" type="tel" placeholder="05xx xxx xx xx" autocomplete="tel" inputmode="tel" />
        </div>
      </div>

      <div>
        <label for="email">E-posta *</label>
        <input id="email" type="email" placeholder="ornek@eposta.com" autocomplete="email" inputmode="email" />
      </div>

      <!-- KVKK -->
      <div class="kvkk-wrap">
        <div class="kvkk-head">
          <h3>KVKK Aydƒ±nlatma Metni</h3>
          <span class="kvkk-badge">Bilgilendirme</span>
        </div>
        <div class="kvkk-content">
Kƒ∞≈ûƒ∞SEL VERƒ∞LERƒ∞N KORUNMASI KANUNU KAPSAMINDA AYDINLATMA METNƒ∞
Bir Bulut Olsam Derneƒüi ("Dernek") olarak, veri sorumlusu sƒ±fatƒ±yla, d√ºzenlediƒüimiz etkinliklere katƒ±lƒ±mƒ±nƒ±z sƒ±rasƒ±nda sizlerden elde edilen ki≈üisel verilerinize b√ºy√ºk √∂nem veriyoruz. (√ñzet metin; tam metin i√ßin ileti≈üim kanallarƒ±mƒ±zdan talep edebilirsiniz.)
        </div>
        <div class="kvkk-controls">
          <input id="kvkk" class="checkbox" type="checkbox" />
          <label for="kvkk">KVKK metnini okudum, onay veriyorum.</label>
        </div>
      </div>

      <button class="btn" id="submitBtn" disabled>
        <span id="btnText">Check-in Yap</span>
      </button>
      <div id="status" class="status"></div>
    </div>

    <div class="footer">
      ¬© 2025 Bir Bulut Olsam Derneƒüi ¬∑ 
      <a href="#" id="openKvkk">KVKK Metni</a>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-label="Kayƒ±t Ba≈üarƒ±lƒ±">
      <canvas class="confetti" id="confetti"></canvas>
      <div class="lead">KAYDINIZ YAPILDI</div>
      <h2>Etkinliƒüe ho≈ü geldiniz! üéâ</h2>
      <p>Kaydƒ±nƒ±z ba≈üarƒ±yla alƒ±ndƒ±. ƒ∞yi ki aramƒ±zdasƒ±nƒ±z!</p>
      <p class="sub" id="countdownText"></p>
      <button class="btn-close" id="closePopup">Kapat</button>
    </div>
  </div>

  <script>
    // Configuration
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxs2lee7tf6GC10kqLYqvqttDu2kwNkg427aYlgVraXiuBm8vS_TRmv2nRibuxZd4u9/exec";
    const REFRESH_INTERVAL = 60000; // 60 seconds

    // Elements
    const elEvent = document.getElementById('event');
    const elName = document.getElementById('name');
    const elPhone = document.getElementById('phone');
    const elEmail = document.getElementById('email');
    const elKvkk = document.getElementById('kvkk');
    const elStatus = document.getElementById('status');
    const btn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const overlay = document.getElementById('overlay');
    const closePopupBtn = document.getElementById('closePopup');
    const countdownText = document.getElementById('countdownText');
    const confettiCanvas = document.getElementById('confetti');

    // State
    let popupTimer = null;
    let selectedMood = null;
    let stars = [];

    // ===== THEME =====
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      updateThemeIcon(savedTheme);
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const newTheme = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    }

    function updateThemeIcon(theme) {
      themeIcon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    themeToggle.addEventListener('click', toggleTheme);

    // ===== UTILITIES =====
    function setStatus(msg, ok = false) {
      elStatus.className = 'status ' + (ok ? 'ok' : 'err');
      elStatus.textContent = msg || '';
      if (msg) setTimeout(() => elStatus.textContent = '', 5000);
    }

    function validatePhone(p) {
      const digits = (p || '').replace(/\D/g, '');
      return digits.length >= 10;
    }

    function validateEmail(e) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e || '');
    }

    // ===== CONSTELLATION MAP =====
    function initConstellation() {
      const canvas = document.getElementById('constellationCanvas');
      const width = canvas.offsetWidth;
      const height = canvas.offsetHeight;
      
      // Generate 20 fixed stars with space for names
      stars = [];
      for (let i = 0; i < 20; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        // Leave 30px padding for names at top/bottom
        star.style.left = Math.random() * (width - 80) + 40 + 'px';
        star.style.top = Math.random() * (height - 60) + 30 + 'px';
        
        // Random twinkle delay
        star.style.animationDelay = Math.random() * 3 + 's';
        
        canvas.appendChild(star);
        stars.push({
          element: star,
          x: parseFloat(star.style.left),
          y: parseFloat(star.style.top)
        });
      }
      
      // Draw constellation lines
      drawConstellationLines();
      
      // Load participant names
      loadConstellationData();
    }
    
    async function loadConstellationData() {
      try {
        let url = WEBAPP_URL + '?action=participants&limit=20';
        
        let data;
        try {
          const res = await fetch(url);
          data = await res.json();
        } catch(_) {
          // JSONP fallback
          data = await new Promise((resolve) => {
            const cb = 'participantsCb_' + Math.random().toString(36).slice(2);
            window[cb] = (d) => { resolve(d); delete window[cb]; };
            const s = document.createElement('script');
            s.src = url + '&callback=' + cb;
            document.body.appendChild(s);
          });
        }
        
        if (data.ok && data.participants) {
          renderParticipantsList(data.participants);
        }
      } catch(err) {
        console.error('Constellation load error:', err);
      }
    }
    
    function renderParticipantsList(participants) {
      const listEl = document.getElementById('participantsList');
      const subtitle = document.getElementById('constellationSubtitle');
      
      if (participants.length === 0) {
        listEl.innerHTML = '<div class="participants-empty">Hen√ºz katƒ±lƒ±mcƒ± yok. ƒ∞lk sen ol! üåü</div>';
        subtitle.textContent = 'Hen√ºz kimse katƒ±lmadƒ±!';
        return;
      }
      
      // Update subtitle
      subtitle.textContent = `Son ${participants.length} katƒ±lƒ±mcƒ±mƒ±z ‚≠ê`;
      
      // Render participants list
      const grid = document.createElement('div');
      grid.className = 'participants-grid';
      
      participants.forEach((p, i) => {
        const item = document.createElement('div');
        item.className = 'participant-item';
        item.textContent = (i + 1) + '. ' + p.name;
        grid.appendChild(item);
      });
      
      listEl.innerHTML = '';
      listEl.appendChild(grid);
      
      // Add names to stars
      addNamesToStars(participants);
    }
    
    function addNamesToStars(participants) {
      // Add names on top of stars
      stars.forEach((star, i) => {
        // Remove old name if exists
        const oldName = star.element.querySelector('.star-name-label');
        if (oldName) oldName.remove();
        
        // Add new name if participant exists
        if (i < participants.length) {
          const nameLabel = document.createElement('div');
          nameLabel.className = 'star-name-label';
          nameLabel.textContent = participants[i].name;
          star.element.appendChild(nameLabel);
        }
      });
    }

    function drawConstellationLines() {
      const canvas = document.getElementById('constellationCanvas');
      
      // Connect nearby stars
      for (let i = 0; i < stars.length; i++) {
        for (let j = i + 1; j < stars.length; j++) {
          const dist = Math.sqrt(
            Math.pow(stars[i].x - stars[j].x, 2) +
            Math.pow(stars[i].y - stars[j].y, 2)
          );
          
          if (dist < 100) {
            const line = document.createElement('div');
            line.className = 'star-line';
            line.style.left = stars[i].x + 4 + 'px';
            line.style.top = stars[i].y + 4 + 'px';
            line.style.width = dist + 'px';
            
            const angle = Math.atan2(
              stars[j].y - stars[i].y,
              stars[j].x - stars[i].x
            );
            line.style.transform = `rotate(${angle}rad)`;
            
            canvas.appendChild(line);
          }
        }
      }
    }

    // ===== MOOD SELECTOR =====
    document.querySelectorAll('.mood-option').forEach(option => {
      option.addEventListener('click', function() {
        document.querySelectorAll('.mood-option').forEach(o => o.classList.remove('selected'));
        this.classList.add('selected');
        selectedMood = this.dataset.mood;
        
        const moodNames = {
          happy: 'Mutlu',
          excited: 'Heyecanlƒ±',
          cool: 'Havalƒ±',
          tired: 'Yorgun'
        };
        
        document.getElementById('moodStats').textContent = 
          `Harika! ${moodNames[selectedMood]} hissettiƒüini kaydettik! üéâ`;
        
        updateButton();
      });
    });
    
    async function loadMoodStats() {
      const eventCode = elEvent.value;
      if (!eventCode) {
        document.getElementById('moodStats').textContent = 'Bir ruh hali se√ß ve check-in yap!';
        return;
      }
      
      try {
        let url = WEBAPP_URL + '?action=moodStats&eventCode=' + eventCode;
        
        let data;
        try {
          const res = await fetch(url);
          data = await res.json();
        } catch(_) {
          // JSONP fallback
          data = await new Promise((resolve) => {
            const cb = 'moodCb_' + Math.random().toString(36).slice(2);
            window[cb] = (d) => { resolve(d); delete window[cb]; };
            const s = document.createElement('script');
            s.src = url + '&callback=' + cb;
            document.body.appendChild(s);
          });
        }
        
        if (data.ok && data.moodStats) {
          displayMoodStats(data.moodStats);
        }
      } catch(err) {
        console.error('Mood stats load error:', err);
      }
    }
    
    function displayMoodStats(stats) {
      const moodStatsEl = document.getElementById('moodStats');
      
      if (stats.total === 0) {
        moodStatsEl.textContent = 'Bu etkinlikte hen√ºz kimse mood se√ßmedi. ƒ∞lk sen ol!';
        return;
      }
      
      const moodEmojis = {
        happy: 'üòä',
        excited: 'ü§ó',
        cool: 'üòé',
        tired: 'üò¥'
      };
      
      const moodNames = {
        happy: 'Mutlu',
        excited: 'Heyecanlƒ±',
        cool: 'Havalƒ±',
        tired: 'Yorgun'
      };
      
      // Find most popular mood
      let maxMood = 'happy';
      let maxCount = 0;
      Object.keys(stats).forEach(mood => {
        if (mood !== 'total' && stats[mood] > maxCount) {
          maxCount = stats[mood];
          maxMood = mood;
        }
      });
      
      // Build stats text
      const statsText = Object.keys(moodEmojis)
        .filter(mood => stats[mood] > 0)
        .map(mood => `${moodEmojis[mood]} ${stats[mood]}`)
        .join(' ‚Ä¢ ');
      
      if (maxCount > 0) {
        const percentage = Math.round((maxCount / stats.total) * 100);
        moodStatsEl.innerHTML = `
          Bu etkinlikte <strong>%${percentage} ${moodNames[maxMood]}</strong> ${moodEmojis[maxMood]}<br>
          <small style="opacity:0.8">${statsText} (${stats.total} ki≈üi)</small>
        `;
      }
    }

    // ===== HEART PROGRESS =====
    function updateHeart() {
      let progress = 0;
      let filledItems = [];
      
      // Mood selected = 20%
      if (selectedMood) {
        progress += 20;
        filledItems.push('Ruh hali');
      }
      
      // Event selected = 20%
      if (elEvent.value) {
        progress += 20;
        filledItems.push('Etkinlik');
      }
      
      // Name filled = 20%
      if (elName.value.trim()) {
        progress += 20;
        filledItems.push('ƒ∞sim');
      }
      
      // Phone filled = 20%
      if (validatePhone(elPhone.value)) {
        progress += 20;
        filledItems.push('Telefon');
      }
      
      // Email filled = 20%
      if (validateEmail(elEmail.value)) {
        progress += 20;
        filledItems.push('E-posta');
      }
      
      heartProgress = progress;
      
      // Update heart visual
      const clipRect = document.getElementById('clipRect');
      const heartPercent = document.getElementById('heartPercent');
      const heartLabel = document.getElementById('heartLabel');
      
      // Animate fill from bottom to top
      const fillHeight = progress;
      clipRect.setAttribute('y', 100 - fillHeight);
      clipRect.setAttribute('height', fillHeight);
      
      heartPercent.textContent = progress + '%';
      
      // Update label
      if (progress === 0) {
        heartLabel.textContent = 'Formu doldurmaya ba≈üla!';
      } else if (progress === 100) {
        heartLabel.textContent = 'üíô Kalp doldu! Artƒ±k check-in yapabilirsin!';
        addHeartSparkle();
      } else {
        const remaining = 5 - filledItems.length;
        heartLabel.textContent = `${filledItems.join(', ')} ‚úì ‚Ä¢ ${remaining} alan kaldƒ±`;
      }
      
      // Update button state
      updateButton();
    }
    
    function addHeartSparkle() {
      const container = document.getElementById('heartSparkles');
      const emojis = ['‚ú®', 'üí´', '‚≠ê', 'üåü', 'üíô'];
      
      for (let i = 0; i < 8; i++) {
        setTimeout(() => {
          const sparkle = document.createElement('div');
          sparkle.className = 'sparkle';
          sparkle.textContent = emojis[Math.floor(Math.random() * emojis.length)];
          sparkle.style.left = Math.random() * 100 + '%';
          sparkle.style.top = Math.random() * 100 + '%';
          container.appendChild(sparkle);
          
          setTimeout(() => sparkle.remove(), 2000);
        }, i * 100);
      }
    }

    // ===== FORM VALIDATION =====
    function updateButton() {
      const ok = elEvent.value && 
                 elName.value.trim() && 
                 validatePhone(elPhone.value) && 
                 validateEmail(elEmail.value) && 
                 elKvkk.checked &&
                 selectedMood;
      btn.disabled = !ok;
    }

    elEvent.addEventListener('change', () => {
      updateButton();
      loadMoodStats();
    });
    elName.addEventListener('input', updateButton);
    elPhone.addEventListener('input', updateButton);
    elEmail.addEventListener('input', updateButton);
    elKvkk.addEventListener('change', updateButton);

    // ===== LOAD EVENTS =====
    async function loadEventsFetch() {
      const res = await fetch(WEBAPP_URL + "?action=events", { method: 'GET' });
      return res.json();
    }

    function loadEventsJSONP() {
      return new Promise((resolve, reject) => {
        const cb = 'bboCb_' + Math.random().toString(36).slice(2);
        window[cb] = (data) => { resolve(data); delete window[cb]; s.remove(); };
        const s = document.createElement('script');
        s.src = WEBAPP_URL + '?action=events&callback=' + cb;
        s.onerror = () => { reject(new Error('JSONP failed')); s.remove(); delete window[cb]; };
        document.body.appendChild(s);
      });
    }

    async function loadEvents() {
      try {
        let data;
        try {
          data = await loadEventsFetch();
        } catch (_) {
          data = await loadEventsJSONP();
        }

        if (!data.ok) throw new Error(data.error || 'Bilinmeyen hata');

        elEvent.innerHTML = '<option value="">Bir etkinlik se√ßin‚Ä¶</option>';
        (data.events || []).forEach(ev => {
          const opt = document.createElement('option');
          opt.value = ev.eventCode;
          opt.textContent = `${ev.eventName} (${ev.eventCode})`;
          elEvent.appendChild(opt);
        });

        if ((data.events || []).length === 0) {
          setStatus('Aktif etkinlik bulunamadƒ±.', false);
        } else {
          setStatus('');
        }

        updateButton();
      } catch (err) {
        setStatus('Etkinlik listesi y√ºklenemedi: ' + err.message, false);
      }
    }

    // ===== SUBMIT CHECK-IN =====
    async function submitCheckin() {
      setStatus('');
      const eventCode = elEvent.value;
      const name = elName.value.trim();
      const phone = elPhone.value.trim();
      const email = elEmail.value.trim();
      const kvkk = elKvkk.checked;

      if (!selectedMood) return setStatus('L√ºtfen ruh halinizi se√ßin.', false);
      if (!eventCode) return setStatus('L√ºtfen bir etkinlik se√ßin.', false);
      if (!name) return setStatus('L√ºtfen ad soyad girin.', false);
      if (!validatePhone(phone)) return setStatus('Telefon formatƒ± hatalƒ±.', false);
      if (!validateEmail(email)) return setStatus('L√ºtfen ge√ßerli bir e-posta girin.', false);
      if (!kvkk) return setStatus('KVKK onayƒ± gereklidir.', false);

      btn.disabled = true;
      btnText.innerHTML = '<span class="spinner"></span> Kaydediliyor...';

      try {
        const body = new URLSearchParams({ 
          eventCode, 
          name, 
          phone, 
          email,
          mood: selectedMood || ''
        });
        const res = await fetch(WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body
        });

        const ok = res.ok ? await res.json().catch(() => ({ ok: true })) : null;

        if (!res.ok || (ok && ok.ok === false)) {
          throw new Error((ok && ok.error) || 'Sunucudan beklenmedik yanƒ±t');
        }

        // Success
        setStatus('Check-in ba≈üarƒ±lƒ±! ƒ∞yi etkinlikler! ‚òÅÔ∏è', true);

        // Reload constellation and mood stats
        await loadConstellationData();
        await loadMoodStats();

        // Reset form
        elName.value = '';
        elPhone.value = '';
        elEmail.value = '';
        elKvkk.checked = false;
        document.querySelectorAll('.mood-option').forEach(o => o.classList.remove('selected'));
        selectedMood = null;
        updateButton();

        // Show popup
        showPopup();

      } catch (err) {
        setStatus('G√∂nderim hatasƒ±: ' + err.message, false);
      } finally {
        btn.disabled = false;
        btnText.textContent = 'Check-in Yap';
      }
    }

    btn.addEventListener('click', submitCheckin);

    // ===== SUCCESS MODAL =====
    function showPopup(autoCloseMs = 4000) {
      overlay.classList.add('open');
      overlay.setAttribute('aria-hidden', 'false');
      startConfetti();
      playSuccessSound();

      if (popupTimer) clearInterval(popupTimer);
      let ms = autoCloseMs;
      countdownText.textContent = ms > 0 ? Math.ceil(ms / 1000) + " sn sonra kapanacak." : "";

      if (ms > 0) {
        popupTimer = setInterval(() => {
          ms -= 1000;
          if (ms <= 0) {
            hidePopup();
          } else {
            countdownText.textContent = Math.ceil(ms / 1000) + " sn sonra kapanacak.";
          }
        }, 1000);
      }
    }

    function hidePopup() {
      overlay.classList.remove('open');
      overlay.setAttribute('aria-hidden', 'true');
      stopConfetti();
      if (popupTimer) {
        clearInterval(popupTimer);
        popupTimer = null;
      }
    }

    closePopupBtn.addEventListener('click', hidePopup);
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) hidePopup();
    });

    // ===== SUCCESS SOUND =====
    function playSuccessSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const notes = [523.25, 659.25, 783.99];

        notes.forEach((freq, i) => {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          oscillator.frequency.value = freq;
          oscillator.type = 'sine';

          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime + i * 0.1);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.1 + 0.3);

          oscillator.start(audioContext.currentTime + i * 0.1);
          oscillator.stop(audioContext.currentTime + i * 0.1 + 0.3);
        });
      } catch (err) {
        console.log('Audio playback failed:', err);
      }
    }

    // ===== CONFETTI =====
    let confettiRAF = null;
    let pieces = [];

    function startConfetti() {
      const ctx = confettiCanvas.getContext('2d');
      resizeConfetti();

      pieces = Array.from({ length: 80 }).map(() => ({
        x: Math.random() * confettiCanvas.width,
        y: -Math.random() * confettiCanvas.height * 0.6,
        r: Math.random() * 6 + 3,
        vy: Math.random() * 3 + 1.5,
        vx: (Math.random() - 0.5) * 2,
        hue: Math.random() * 360,
        rotation: Math.random() * Math.PI * 2,
        rotationSpeed: (Math.random() - 0.5) * 0.2
      }));

      function step() {
        ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);

        pieces.forEach(p => {
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rotation);

          ctx.beginPath();
          ctx.rect(-p.r / 2, -p.r / 2, p.r, p.r);
          ctx.fillStyle = `hsl(${p.hue}, 85%, 60%)`;
          ctx.fill();

          ctx.restore();

          p.y += p.vy;
          p.x += p.vx;
          p.rotation += p.rotationSpeed;

          if (p.y > confettiCanvas.height + 10) {
            p.y = -10;
            p.x = Math.random() * confettiCanvas.width;
          }
        });

        confettiRAF = requestAnimationFrame(step);
      }

      step();
      window.addEventListener('resize', resizeConfetti);
    }

    function stopConfetti() {
      if (confettiRAF) cancelAnimationFrame(confettiRAF);
      confettiRAF = null;
      window.removeEventListener('resize', resizeConfetti);
    }

    function resizeConfetti() {
      const modal = document.querySelector('.modal');
      confettiCanvas.width = modal.clientWidth;
      confettiCanvas.height = modal.clientHeight;
    }

    // ===== KVKK LINK =====
    document.getElementById('openKvkk').addEventListener('click', (e) => {
      e.preventDefault();
      const kvkkWrap = document.querySelector('.kvkk-wrap');
      kvkkWrap.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });

    // ===== INITIALIZATION =====
    function init() {
      initTheme();
      initConstellation();
      loadEvents();
      updateButton();
      
      // Auto-refresh constellation and mood stats every 60 seconds
      setInterval(() => {
        loadConstellationData(); // Refresh participant names
        if (elEvent.value) {
          loadMoodStats(); // Refresh mood stats
        }
      }, REFRESH_INTERVAL);
    }

    // Start app
    init();

    // Cleanup
    window.addEventListener('beforeunload', () => {
      if (popupTimer) clearInterval(popupTimer);
    });

    // Prevent double-tap zoom on buttons (iOS)
    document.addEventListener('touchend', function(e) {
      const now = Date.now();
      const lastTouch = this.lastTouch || 0;
      if (now - lastTouch < 300) {
        e.preventDefault();
      }
      this.lastTouch = now;
    }, { passive: false });
  </script>
</body>
</html>
