<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Bir Bulut Olsam — Etkinlik Check-in</title>
  <meta name="theme-color" content="#5B8DEF" />
  <style>
    :root{
      --bg:#F4F7FF; --card:#FFFFFF; --primary:#5B8DEF; --primary-700:#355CD6; --accent:#8EE1F7;
      --ok:#0f766e; --err:#b91c1c; --text:#111827; --muted:#64748b; --shadow:0 10px 30px rgba(43,78,255,.12);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:radial-gradient(1200px 600px at 80% -10%, #dbeafe 0%, transparent 60%),var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
    .wrap{max-width:720px;margin:min(6vh,48px) auto;padding:16px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:clamp(18px,2.8vw,28px);overflow:hidden;border:1px solid #e5e7eb}
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--primary),var(--accent));box-shadow:0 6px 18px rgba(91,141,239,.35);position:relative}
    .logo:before,.logo:after{content:"";position:absolute;background:#fff;border-radius:999px;opacity:.9}
    .logo:before{width:18px;height:18px;left:8px;top:14px}
    .logo:after{width:26px;height:26px;left:18px;top:8px}
    h1{font-size:clamp(1.2rem,1.1rem + 1.2vw,1.8rem);margin:6px 0 2px}
    .sub{color:var(--muted);font-size:.95rem;margin:0 0 14px}
    label{display:block;font-weight:600;margin:14px 0 8px}
    select,input[type="text"],input[type="tel"],input[type="email"]{width:100%;padding:14px 12px;border:1px solid #d7dce7;border-radius:12px;font-size:1rem;outline:none;background:#fff}
    select:focus,input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(91,141,239,.18)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}

    .kvkk-wrap{margin-top:12px;border:1px solid #e2e8f0;border-radius:14px;overflow:hidden;background:#fafcff}
    .kvkk-head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;background:linear-gradient(180deg,#f0f7ff,#ecf3ff);border-bottom:1px solid #e2e8f0}
    .kvkk-head h3{margin:0;font-size:1rem}
    .kvkk-badge{font-size:.8rem;color:#334155;background:#e2e8f0;padding:4px 8px;border-radius:999px}
    .kvkk-body{background:#fff}
    .kvkk-content{padding:14px;line-height:1.5;white-space:pre-wrap;font-size:.95rem;color:#334155}
    .kvkk-controls{display:flex;align-items:center;gap:10px;margin-top:12px;padding:0 14px 14px}
    .checkbox{width:20px;height:20px}

    .btn{width:100%;padding:14px;border:0;border-radius:12px;font-weight:700;font-size:1rem;color:#fff;background:linear-gradient(135deg,var(--primary),var(--primary-700));cursor:pointer;box-shadow:0 10px 24px rgba(53,92,214,.25)}
    .btn:disabled{opacity:.65;cursor:not-allowed;box-shadow:none}

    .status{margin-top:12px;font-size:.95rem}
    .ok{color:var(--ok)} .err{color:var(--err)}

    @media (hover:none){select,input,button,label{min-height:48px}}
    .footer{text-align:center;color:#64748b;font-size:.9rem;margin-top:14px}
    .footer a{color:#355CD6;text-decoration:none}

    /* === TAM EKRAN POP-UP OVERLAY === */
    .overlay{position:fixed;inset:0;background:rgba(9,12,22,.55);backdrop-filter:saturate(120%) blur(6px);display:none;align-items:center;justify-content:center;z-index:9999}
    .overlay.open{display:flex}
    .modal{
      max-width:min(760px,92vw);width:100%;background:#fff;border-radius:22px;padding:28px;
      box-shadow:0 18px 60px rgba(0,0,0,.22);text-align:center;position:relative;overflow:hidden;
      border:1px solid #e5e7eb;
    }
    .modal h2{font-size:clamp(1.4rem,1.1rem + 1.6vw,2rem);margin:0 0 6px}
    .modal .lead{
      font-weight:800;letter-spacing:.2px;font-size:clamp(1.2rem,1rem + 1vw,1.5rem);
      background:linear-gradient(135deg,#4da3ff,#7bdaff,#7bf5c5);
      -webkit-background-clip:text;background-clip:text;color:transparent;margin-bottom:8px
    }
    .modal p{margin:0 0 8px;color:#374151}
    .modal .sub{font-size:.9rem;color:#6b7280}
    .modal .btn-close{
      margin-top:14px;display:inline-block;padding:12px 16px;border-radius:12px;border:0;background:#111;color:#fff;font-weight:700;cursor:pointer
    }
    .confetti{position:absolute;inset:0;pointer-events:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <strong>Bir Bulut Olsam Derneği</strong>
          <div class="sub">Etkinlik Check-in</div>
        </div>
      </div>

      <label for="event">Etkinlik Seç</label>
      <select id="event">
        <option value="">Yükleniyor…</option>
      </select>

      <div class="grid">
        <div>
          <label for="name">Ad Soyad</label>
          <input id="name" type="text" placeholder="Ad Soyad" autocomplete="name" />
        </div>
        <div>
          <label for="phone">Telefon</label>
          <input id="phone" type="tel" placeholder="05xx xxx xx xx" autocomplete="tel" inputmode="tel" />
        </div>
      </div>

      <!-- E-Posta (zorunlu) -->
      <div>
        <label for="email">E-posta</label>
        <input id="email" type="email" placeholder="ornek@eposta.com" autocomplete="email" />
      </div>

      <!-- KVKK (kaydırma şartı yok) -->
      <div class="kvkk-wrap" id="kvkkWrap">
        <div class="kvkk-head">
          <h3>KİŞİSEL VERİLERİN KORUNMASI KANUNU KAPSAMINDA AYDINLATMA METNİ</h3>
          <span class="kvkk-badge">Bilgilendirme</span>
        </div>
        <div class="kvkk-body" id="kvkkBody" aria-hidden="false">
          <div class="kvkk-content" id="kvkkContent">
KİŞİSEL VERİLERİN KORUNMASI KANUNU KAPSAMINDA AYDINLATMA METNİ
Bir Bulut Olsam Derneği ("Dernek") olarak, veri sorumlusu sıfatıyla, düzenlediğimiz etkinliklere katılımınız sırasında sizlerden elde edilen kişisel verilerinize büyük önem veriyoruz. (Özet metin; tam metin için iletişim kanallarımızdan talep edebilirsiniz.)
          </div>
          <div class="kvkk-controls">
            <input id="kvkk" class="checkbox" type="checkbox" />
            <label for="kvkk" style="font-weight:600;margin:0;">KVKK metnini okudum, kişisel verilerimin işlenmesine onay veriyorum.</label>
          </div>
        </div>
      </div>

      <button class="btn" id="submitBtn" disabled>Check-in Yap</button>
      <div id="status" class="status"></div>
    </div>

    <div class="footer">© Bir Bulut Olsam Derneği · <a href="#" id="openKvkk">KVKK Metni (kısa)</a></div>
  </div>

  <!-- === TAM EKRAN POP-UP === -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-label="Kayıt Başarılı">
      <canvas class="confetti" id="confetti"></canvas>
      <div class="lead">KAYDINIZ YAPILDI</div>
      <h2>Etkinliğe hoş geldiniz, iyi ki aramızdasınız! 🎉</h2>
      <p>Kaydınız başarıyla alındı. Girişte görevliye adınızı iletebilirsiniz.</p>
      <p class="sub" id="countdownText"></p>
      <button class="btn-close" id="closePopup">Kapat</button>
    </div>
  </div>

  <script>
    // Apps Script EXEC URL — kendi ID’n ile
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwDdDI4SIlDsIAa3FEdF5OuTVtTtVGKOHK4NxAQKVFtyA7TF2owetWwW-VOy7_g671k/exec";

    // Elemanlar
    const elEvent = document.getElementById('event');
    const elName  = document.getElementById('name');
    const elPhone = document.getElementById('phone');
    const elEmail = document.getElementById('email');
    const elKvkk  = document.getElementById('kvkk');
    const elStatus= document.getElementById('status');
    const btn     = document.getElementById('submitBtn');
    const openKvkk= document.getElementById('openKvkk');

    // Popup elemanları
    const overlay = document.getElementById('overlay');
    const closePopupBtn = document.getElementById('closePopup');
    const countdownText = document.getElementById('countdownText');
    const confettiCanvas = document.getElementById('confetti');
    let popupTimer = null;

    function setStatus(msg, ok=false){
      elStatus.className = 'status ' + (ok ? 'ok' : 'err');
      elStatus.textContent = msg || '';
    }
    function validatePhone(p){
      const digits = (p||'').replace(/\D/g,'');
      return digits.length >= 10;
    }
    function validateEmail(e){
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e || '');
    }

    // KVKK kısa metin bağlantısı (sadece aç-kapa)
    openKvkk.addEventListener('click', (e)=>{ e.preventDefault(); window.scrollTo({ top: document.getElementById('kvkkWrap').offsetTop - 12, behavior: 'smooth' }); });

    // Buton durumunu alanlara göre ayarla
    function updateButton(){
      const ok = elEvent.value && elName.value.trim() && validatePhone(elPhone.value) && validateEmail(elEmail.value) && elKvkk.checked;
      btn.disabled = !ok;
    }
    elEvent.addEventListener('change', updateButton);
    elName.addEventListener('input', updateButton);
    elPhone.addEventListener('input', updateButton);
    elEmail.addEventListener('input', updateButton);
    elKvkk.addEventListener('change', updateButton);

    // Etkinlikleri yükle: önce fetch; CORS hatasında JSONP fallback
    async function loadEventsFetch(){
      const res = await fetch(WEBAPP_URL + "?action=events", { method:'GET' });
      return res.json();
    }
    function loadEventsJSONP(){
      return new Promise((resolve,reject)=>{
        const cb = 'bboCb_' + Math.random().toString(36).slice(2);
        window[cb] = (data)=>{ resolve(data); delete window[cb]; s.remove(); };
        const s = document.createElement('script');
        s.src = WEBAPP_URL + '?action=events&callback=' + cb;
        s.onerror = ()=>{ reject(new Error('JSONP yüklenemedi')); s.remove(); delete window[cb]; };
        document.body.appendChild(s);
      });
    }
    async function loadEvents(){
      try{
        let data;
        try{ data = await loadEventsFetch(); }
        catch(_){ data = await loadEventsJSONP(); }

        if (!data.ok) throw new Error(data.error || 'Bilinmeyen hata');
        elEvent.innerHTML = '<option value="">Bir etkinlik seçin…</option>';
        (data.events||[]).forEach(ev=>{
          const opt = document.createElement('option');
          opt.value = ev.eventCode;
          opt.textContent = `${ev.eventName} (${ev.eventCode})`;
          elEvent.appendChild(opt);
        });
        if ((data.events||[]).length===0) setStatus('Aktif etkinlik bulunamadı.', false);
        else setStatus('');
        updateButton();
      }catch(err){
        setStatus('Etkinlik listesi yüklenemedi: ' + err.message, false);
      }
    }

    // === TAM EKRAN POP-UP ===
    function showPopup(message = 'KAYDINIZ YAPILDI ETKİNLİĞE HOŞGELDİNİZ, İYİ Kİ ARAMIZDASINIZ', autoCloseMs = 4000){
      // Mesaj üst başlıkta zaten; istersen alt satıra da yazabilirsin
      overlay.classList.add('open');
      overlay.setAttribute('aria-hidden','false');
      startConfetti();

      if (popupTimer) clearInterval(popupTimer);
      let ms = autoCloseMs;
      countdownText.textContent = (ms>0) ? Math.ceil(ms/1000) + " sn sonra kapanacak." : "";
      if (ms>0){
        popupTimer = setInterval(()=>{
          ms -= 1000;
          if (ms <= 0){
            hidePopup();
          } else {
            countdownText.textContent = Math.ceil(ms/1000) + " sn sonra kapanacak.";
          }
        }, 1000);
      }
    }
    function hidePopup(){
      overlay.classList.remove('open');
      overlay.setAttribute('aria-hidden','true');
      stopConfetti();
      if (popupTimer) { clearInterval(popupTimer); popupTimer=null; }
    }
    closePopupBtn.addEventListener('click', hidePopup);
    overlay.addEventListener('click', (e)=>{ if(e.target === overlay) hidePopup(); });

    // Basit konfeti
    let confettiRAF = null;
    let pieces = [];
    function startConfetti(){
      const ctx = confettiCanvas.getContext('2d');
      resizeConfetti();
      pieces = Array.from({length:90}).map(()=>({
        x: Math.random()*confettiCanvas.width,
        y: -Math.random()*confettiCanvas.height*0.6,
        r: Math.random()*5+3,
        vy: Math.random()*2+1.2,
        vx: (Math.random()-0.5)*1.6,
        hue: Math.random()*360
      }));
      function step(){
        ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
        pieces.forEach(p=>{
          ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
          ctx.fillStyle = `hsl(${p.hue},85%,60%)`;
          ctx.fill();
          p.y += p.vy; p.x += p.vx; if(p.y>confettiCanvas.height+10) p.y = -10;
        });
        confettiRAF = requestAnimationFrame(step);
      }
      step();
      window.addEventListener('resize', resizeConfetti);
    }
    function stopConfetti(){
      if (confettiRAF) cancelAnimationFrame(confettiRAF);
      confettiRAF = null;
      window.removeEventListener('resize', resizeConfetti);
    }
    function resizeConfetti(){
      confettiCanvas.width = document.querySelector('.modal').clientWidth;
      confettiCanvas.height = document.querySelector('.modal').clientHeight;
    }

    // PRE-FLIGHT tetiklemeyen POST (URL-encoded)
    async function submitCheckin(){
      setStatus('');
      const eventCode = elEvent.value;
      const name  = elName.value.trim();
      const phone = elPhone.value.trim();
      const email = elEmail.value.trim();
      const kvkk  = elKvkk.checked;

      if (!eventCode) return setStatus('Lütfen bir etkinlik seçin.', false);
      if (!name) return setStatus('Lütfen ad soyad girin.', false);
      if (!validatePhone(phone)) return setStatus('Telefon formatı hatalı görünüyor.', false);
      if (!validateEmail(email)) return setStatus('Lütfen geçerli bir e-posta girin.', false);
      if (!kvkk) return setStatus('KVKK onayı gereklidir.', false);

      btn.disabled = true;
      try{
        const body = new URLSearchParams({ eventCode, name, phone, email });
        const res = await fetch(WEBAPP_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
          body
        });
        const ok = res.ok ? await res.json().catch(()=>({ok:true})) : null;
        if (!res.ok || (ok && ok.ok===false)) {
          throw new Error((ok && ok.error) || 'Sunucudan beklenmedik yanıt');
        }

        // Formu resetle
        setStatus('Check-in alındı. İyi etkinlikler! ☁️', true);
        elName.value=''; elPhone.value=''; elEmail.value='';
        elKvkk.checked=false;
        updateButton();

        // TAM EKRAN POP-UP
        showPopup();
      }catch(err){
        setStatus('Gönderim hatası: ' + err.message, false);
      }finally{
        btn.disabled = false;
      }
    }
    document.getElementById('submitBtn').addEventListener('click', submitCheckin);

    // Başlat
    (function init(){ loadEvents(); updateButton(); })();
  </script>
</body>
</html>
