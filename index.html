/**
 * BIR BULUT OLSAM DERNEĞİ - ETKİNLİK CHECK-IN SİSTEMİ v3.4
 * - Belirli bir Google Sheet ID'sine bağlı çalışır
 * - Events & Checkins sayfaları bu dosyanın içinde olmalı
 */

const CONFIG = {
  TIMEZONE: 'Europe/Istanbul',

  // !!! BURASI ÖNEMLİ: SENİN PAYLAŞTIĞIN SHEET IDsİ !!!
  SPREADSHEET_ID: '1HODERudxpiEXGcpRN53r6AoLIWY5dP_Z4unXfu9N8jw',
  
  // Events sayfasındaki zorunlu başlıklar
  EVENTS_REQUIRED_COLS: ['EventCode', 'EventName', 'Status'],
  STATUS_ACTIVE_VALUE: 'Active',

  // Checkins sayfasındaki zorunlu başlıklar
  CHECKIN_REQUIRED_COLS: ['Timestamp', 'EventCode', 'EventName', 'Phone'],
  
  // İsim sütunu olası başlıkları
  NAME_HEADER_CANDIDATES: [
    'Name-Surname', // Öncelikli
    'Name Surname', 'Name', 'Ad Soyad', 'İsim Soyisim'
  ],
  
  // Email sütunu olası başlıkları
  EMAIL_HEADER_CANDIDATES: [
    'Email', 'E-mail', 'E-posta'
  ]
};

var _CACHE = {
  ss: null,
  eventsSheet: null,
  checkinsSheet: null
};

/** ==== Spreadsheet Erişimi ==== */

function getSpreadsheet_() {
  if (_CACHE.ss) return _CACHE.ss;
  _CACHE.ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  return _CACHE.ss;
}

/** ==== Web App Çıkışı ==== */
function doGet(e) {
  return HtmlService
    .createTemplateFromFile('Index') // HTML dosya adı
    .evaluate()
    .setTitle('Bir Bulut Olsam - Check-in')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

/** ==== Frontend API Fonksiyonları ==== */

function getActiveEvents() {
  return getActiveEvents_();
}

function registerParticipant(data) {
  const lock = LockService.getScriptLock();
  try {
    lock.waitLock(10000); 
  } catch (e) {
    return { success: false, message: 'Sunucu yoğun, lütfen tekrar deneyin.' };
  }

  try {
    const result = recordCheckin_(data || {});
    return { success: true, message: result.message };
  } catch (err) {
    const msg = (err && err.message) ? err.message : 'Bilinmeyen bir hata oluştu.';
    return { success: false, message: msg };
  } finally {
    lock.releaseLock();
  }
}

/** ==== Yardımcı Fonksiyonlar ==== */

function getSheetHeaders_(sheet) {
  const lastCol = Math.max(1, sheet.getLastColumn());
  const row = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
  return row.map(v => String(v).trim());
}

function buildHeaderMap_(headers) {
  const map = {};
  headers.forEach((h, i) => {
    if (h) map[h] = i;
  });
  return map;
}

function findEventsSheet_() {
  if (_CACHE.eventsSheet) return _CACHE.eventsSheet;
  const ss = getSpreadsheet_();
  let sheet = ss.getSheetByName('Events');
  
  if (!sheet) {
    const need = CONFIG.EVENTS_REQUIRED_COLS;
    sheet = ss.getSheets().find(sh => {
      const headers = getSheetHeaders_(sh);
      return need.every(h => headers.includes(h));
    });
  }
  _CACHE.eventsSheet = sheet || null;
  return _CACHE.eventsSheet;
}

function findCheckinsSheet_() {
  if (_CACHE.checkinsSheet) return _CACHE.checkinsSheet;
  const ss = getSpreadsheet_();
  let sheet = ss.getSheetByName('Checkins');

  if (!sheet) {
    const need = CONFIG.CHECKIN_REQUIRED_COLS;
    sheet = ss.getSheets().find(sh => {
      const headers = getSheetHeaders_(sh);
      return need.every(h => headers.includes(h));
    });
  }
  _CACHE.checkinsSheet = sheet || null;
  return _CACHE.checkinsSheet;
}

function detectHeader_(sheet, candidates, defaultVal) {
  const headers = getSheetHeaders_(sheet);
  // Tam eşleşme
  for (let c of candidates) {
    if (headers.includes(c)) return c;
  }
  // Case-insensitive eşleşme
  const lowerHeaders = headers.map(h => h.toLowerCase());
  for (let c of candidates) {
    const idx = lowerHeaders.indexOf(c.toLowerCase());
    if (idx !== -1) return headers[idx];
  }
  return defaultVal;
}

function normalizePhone_(raw) {
  const digits = String(raw || '').replace(/\D+/g, '');
  if (digits.length === 10) return '0' + digits;
  return digits;
}

function isValidEmail_(email) {
  if (!email) return true; // boş ise sorun yapma (HTML required)
  const s = String(email).trim();
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
}

/** ==== İş Mantığı ==== */

function getActiveEvents_() {
  const sh = findEventsSheet_();
  if (!sh) return []; 
  
  const values = sh.getDataRange().getValues();
  if (values.length < 2) return [];

  const headers = values[0].map(v => String(v).trim());
  const map = buildHeaderMap_(headers);

  const iCode = map['EventCode'];
  const iName = map['EventName'];
  const iStat = map['Status'];

  if (iCode === undefined || iName === undefined || iStat === undefined) {
    return [];
  }

  const out = [];
  const targetStatus = CONFIG.STATUS_ACTIVE_VALUE.toUpperCase();

  for (let r = 1; r < values.length; r++) {
    const row = values[r];
    const status = String(row[iStat] || '').trim().toUpperCase();
    if (status === targetStatus) {
      out.push({
        code: String(row[iCode] || '').trim(),
        name: String(row[iName] || '').trim()
      });
    }
  }
  return out;
}

function getEventNameByCode_(eventCode) {
  const sh = findEventsSheet_();
  if (!sh) return null;
  const values = sh.getDataRange().getValues();
  
  const headers = values[0].map(v => String(v).trim());
  const map = buildHeaderMap_(headers);
  const iCode = map['EventCode'];
  const iName = map['EventName'];
  const iStat = map['Status'];

  if (iCode === undefined || iName === undefined || iStat === undefined) {
    return null;
  }

  const wanted = String(eventCode || '').trim();
  const targetStatus = CONFIG.STATUS_ACTIVE_VALUE.toUpperCase();

  for (let r = 1; r < values.length; r++) {
    const row = values[r];
    const code = String(row[iCode] || '').trim();
    const status = String(row[iStat] || '').trim().toUpperCase();
    
    if (code === wanted && status === targetStatus) {
      return String(row[iName] || '').trim();
    }
  }
  return null;
}

function recordCheckin_(data) {
  const sh = findCheckinsSheet_();
  if (!sh) {
    throw new Error('Checkins sayfası bulunamadı.');
  }

  const headers = getSheetHeaders_(sh);
  const map = buildHeaderMap_(headers);

  const nameHeader = detectHeader_(sh, CONFIG.NAME_HEADER_CANDIDATES, 'Name-Surname');
  const emailHeader = detectHeader_(sh, CONFIG.EMAIL_HEADER_CANDIDATES, 'Email');

  const iTimestamp = map['Timestamp'];
  const iEventCode = map['EventCode'];
  const iEventName = map['EventName'];
  const iPhone = map['Phone'];
  const iName = map[nameHeader];
  const iEmail = map[emailHeader];

  const eventCode = String(data.eventCode || '').trim();
  const phone = normalizePhone_(data.phone);
  const name = String(data.fullName || '').trim();
  const email = data.email ? String(data.email).trim() : '';

  if (!eventCode) throw new Error('Etkinlik seçimi yapılamadı.');
  if (!phone) throw new Error('Telefon numarası eksik.');
  if (!name) throw new Error('İsim eksik.');
  if (!isValidEmail_(email)) throw new Error('Lütfen geçerli bir e-posta adresi girin.');

  const eventName = getEventNameByCode_(eventCode);
  if (!eventName) {
    throw new Error('Seçilen etkinlik (' + eventCode + ') şu an aktif değil.');
  }

  const newRow = new Array(headers.length).fill('');
  const now = new Date();

  if (iTimestamp !== undefined) newRow[iTimestamp] = now;
  if (iEventCode !== undefined) newRow[iEventCode] = eventCode;
  if (iEventName !== undefined) newRow[iEventName] = eventName;
  if (iPhone !== undefined) newRow[iPhone] = phone;
  if (iName !== undefined) newRow[iName] = name;
  if (iEmail !== undefined) newRow[iEmail] = email;

  sh.appendRow(newRow);

  return {
    ok: true,
    message: 'Kayıt başarılı! İyi eğlenceler. ☁️'
  };
}
