<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BBO — Check-in</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f6f7fb; }
    .wrap { max-width: 560px; margin: 40px auto; background: #fff; border-radius: 16px; padding: 24px; box-shadow: 0 6px 24px rgba(0,0,0,0.07); }
    h1 { font-size: 1.25rem; margin: 0 0 12px; }
    label { display:block; font-size: 0.95rem; margin: 14px 0 6px; }
    input, select, button { width: 100%; padding: 12px; border: 1px solid #d8dbe3; border-radius: 10px; font-size: 1rem; }
    button { cursor: pointer; border: 0; background: #4f46e5; color: #fff; font-weight: 600; margin-top: 14px; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .help { font-size: .9rem; color:#5b6171; margin-top: 6px; }
    .status { margin-top: 14px; font-size: .95rem; }
    .ok { color:#0f766e; }
    .err { color:#b91c1c; }
    .kvkk { display:flex; gap:10px; align-items:flex-start; margin-top: 10px; }
    .kvkk input { width: auto; }
    .brand { display:flex; align-items:center; gap:10px; margin-bottom: 12px; color:#334155; }
    .brand .dot { width:10px;height:10px;border-radius:50%;background:#60a5fa; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand"><span class="dot"></span><strong>Bir Bulut Olsam Derneği</strong></div>
    <h1>Etkinlik Check-in</h1>

    <div id="status" class="status"></div>

    <label for="event">Etkinlik Seç</label>
    <select id="event">
      <option value="">Yükleniyor…</option>
    </select>
    <div class="help">Listede yalnızca <em>Active</em> durumundaki etkinlikler görünür.</div>

    <div class="row">
      <div>
        <label for="name">Ad Soyad</label>
        <input id="name" type="text" placeholder="Ad Soyad" autocomplete="name" />
      </div>
      <div>
        <label for="phone">Telefon</label>
        <input id="phone" type="tel" placeholder="05xx xxx xx xx" autocomplete="tel" />
      </div>
    </div>

    <label class="kvkk">
      <input id="kvkk" type="checkbox" />
      <span>Kişisel verilerimin, bu etkinliğe girişimin kaydı ve doğrulanması amacıyla işlenmesini onaylıyorum.</span>
    </label>

    <button id="submitBtn">Check-in Yap</button>
  </div>

  <script>
    // Apps Script Web App URL'in:
    const WEBAPP_URL = "https://script.google.com/a/macros/birbulutolsam.com/s/AKfycby5vzhLsuviao06oTuCctEWDCMSypmySNN3T7fBF0-jepueKf1ujrKeUFjtCJuoADzX/exec";

    const elEvent = document.getElementById('event');
    const elName = document.getElementById('name');
    const elPhone = document.getElementById('phone');
    const elKvkk = document.getElementById('kvkk');
    const elStatus = document.getElementById('status');
    const btn = document.getElementById('submitBtn');

    function setStatus(msg, ok=false) {
      elStatus.className = 'status ' + (ok ? 'ok' : 'err');
      elStatus.textContent = msg || '';
    }

    async function loadEvents() {
      try {
        const res = await fetch(WEBAPP_URL + "?action=events", { method: 'GET' });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Bilinmeyen hata');

        elEvent.innerHTML = '<option value="">Bir etkinlik seçin…</option>';
        data.events.forEach(ev => {
          const opt = document.createElement('option');
          opt.value = ev.eventCode;               // sadece eventCode göndereceğiz
          opt.textContent = `${ev.eventName} (${ev.eventCode})`;
          elEvent.appendChild(opt);
        });

        if (data.events.length === 0) {
          setStatus('Aktif etkinlik bulunamadı.', false);
        } else {
          setStatus('');
        }
      } catch (err) {
        setStatus('Etkinlik listesi yüklenemedi: ' + err.message, false);
      }
    }

    function validatePhone(p) {
      // temel TR cep formatı kontrolü (esnek)
      const digits = p.replace(/\D/g,'');
      return digits.length >= 10; // 05xxxxxxxx gibi
    }

    async function submitCheckin() {
      setStatus('');
      const eventCode = elEvent.value;
      const name = elName.value.trim();
      const phone = elPhone.value.trim();
      const kvkk = elKvkk.checked;

      if (!eventCode) return setStatus('Lütfen bir etkinlik seçin.', false);
      if (!name) return setStatus('Lütfen ad soyad girin.', false);
      if (!phone) return setStatus('Lütfen telefon girin.', false);
      if (!validatePhone(phone)) return setStatus('Telefon formatı hatalı görünüyor.', false);
      if (!kvkk) return setStatus('KVKK onayı gereklidir.', false);

      btn.disabled = true;
      try {
        const res = await fetch(WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          // Sadece eventCode, name, phone gönderiyoruz
          body: JSON.stringify({ eventCode, name, phone })
        });
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Kayıt başarısız');

        setStatus('Check-in başarıyla alındı. İyi etkinlikler! ☁️', true);
        elName.value = '';
        elPhone.value = '';
        elKvkk.checked = false;
      } catch (err) {
        setStatus('Gönderim hatası: ' + err.message, false);
      } finally {
        btn.disabled = false;
      }
    }

    btn.addEventListener('click', submitCheckin);
    loadEvents();
  </script>
</body>
</html>
